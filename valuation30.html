<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Board Manager V34 (Performance Fix)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .autocomplete-container { position: relative; z-index: 50; }
        .suggestions {
            position: absolute; top: 100%; left: 0; z-index: 100; 
            width: 100%; max-height: 250px; overflow-y: auto; 
            background: white; border: 1px solid #cbd5e1;
            border-radius: 0 0 8px 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; color: #334155; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover { background-color: #f0f9ff; color: #0284c7; }
        .hidden { display: none; }
        
        .loader-bar { height: 4px; width: 100%; background-color: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .loader-progress { height: 100%; background-color: #4f46e5; width: 0%; transition: width 0.5s ease; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .dashboard-list { max-height: 400px; overflow-y: auto; }
        td { vertical-align: top; }
        .reg-list { font-family: 'Courier New', monospace; font-size: 0.7rem; line-height: 1.4; }
        .reg-list span.absent { color: #dc2626; text-decoration: line-through; font-weight: bold; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">

    <div class="max-w-[98%] mx-auto bg-white rounded-2xl shadow-xl border border-slate-200">
        
        <div class="bg-indigo-900 p-6 text-white flex flex-col md:flex-row justify-between items-center gap-4 rounded-t-2xl">
            <div>
                <h1 class="text-2xl font-bold flex items-center gap-3">
                    <i class="fas fa-bolt text-yellow-400"></i> Valuation Board Manager
                </h1>
                <p class="text-indigo-200 text-sm mt-1">V34 (High Performance & Crash Fix)</p>
            </div>
            <div class="text-right flex flex-col items-end">
                <div class="flex items-center gap-2">
                    <span id="saveStatus" class="text-[10px] uppercase font-bold text-indigo-300 opacity-0 transition-opacity">Saved</span>
                    <span class="bg-indigo-700 px-3 py-1 rounded-full text-xs font-mono border border-indigo-500 shadow-sm">V34</span>
                </div>
                <div class="text-xs text-indigo-300 mt-2 flex items-center gap-2">
                    <span id="connectionDot" class="w-2 h-2 rounded-full bg-red-500"></span>
                    <span id="connectionStatus">Connecting...</span>
                </div>
            </div>
        </div>

        <div class="p-6 space-y-8">
            <div class="flex justify-between items-center">
                <div class="w-1/3">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Chairman Name</label>
                    <div class="autocomplete-container">
                        <input type="text" id="chairmanNameInput" class="border border-slate-300 rounded px-2 py-1 text-sm w-full" placeholder="Search Faculty..." oninput="debounceSave()">
                        <div id="suggChairman" class="suggestions hidden"></div>
                    </div>
                </div>
                <button onclick="clearSession()" class="text-xs text-red-400 hover:text-red-600 underline">Reset Entire Session</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                
                <div class="lg:col-span-1 bg-slate-50 rounded-xl border border-slate-200 p-5 h-fit shadow-inner">
                    <h3 class="font-bold text-slate-700 mb-4 flex items-center justify-between">
                        <span>Paper Status</span>
                        <span class="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600" id="totalPapersCount">0 Papers</span>
                    </h3>
                    
                    <div class="mb-3">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Select Discipline</label>
                        <div class="autocomplete-container">
                            <input type="text" id="disciplineSearch" placeholder="Loading..." class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" disabled>
                            <div id="disciplineSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>

                    <div id="statusDashboard" class="dashboard-list space-y-3 custom-scrollbar">
                        <div class="text-center text-slate-400 text-xs py-10">Select Discipline to View Status</div>
                    </div>
                </div>

                <div id="allocationPanel" class="lg:col-span-2 space-y-8 hidden">
                    
                    <div class="bg-white border-2 border-indigo-100 rounded-xl p-6 shadow-sm relative z-20">
                        <h4 class="font-bold text-indigo-800 mb-6 border-b pb-2 flex items-center gap-2">
                            <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                            Assign Bundle
                        </h4>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Date</label>
                                <input type="date" id="allocDate" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Session</label>
                                <select id="allocSession" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                                    <option value="FN">Forenoon (FN)</option>
                                    <option value="AN">Afternoon (AN)</option>
                                </select>
                            </div>

                            <div class="autocomplete-container">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Chief Examiner</label>
                                <input type="text" id="allocChief" placeholder="Search..." class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                                <div id="suggChief" class="suggestions hidden"></div>
                            </div>
                            <div class="autocomplete-container">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Additional Examiner</label>
                                <input type="text" id="allocAdditional" placeholder="Search..." class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                                <div id="suggAdditional" class="suggestions hidden"></div>
                            </div>

                            <div class="autocomplete-container md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Select Paper (QP Code)</label>
                                <input type="text" id="allocQP" placeholder="Type QP Code or Paper Name..." class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                                <div id="suggQP" class="suggestions hidden"></div>
                            </div>

                            <div class="autocomplete-container">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Start Register No</label>
                                <input type="text" id="allocStartReg" placeholder="Select QP First" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-mono">
                                <div id="suggStartReg" class="suggestions hidden"></div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">Target Count (Present Only)</label>
                                <div class="flex gap-2">
                                    <input type="number" id="allocCount" value="20" class="w-24 border border-slate-300 rounded-lg p-2 text-sm font-bold text-center">
                                    <div class="text-xs text-slate-400 flex items-center">
                                        Includes absents automatically.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end pt-4 border-t border-slate-100">
                            <button onclick="addAllocation()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-bold text-sm shadow-md transition-all flex items-center gap-2">
                                <i class="fas fa-plus-circle"></i> Add Allocation
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
                        <div class="p-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                            <h4 class="font-bold text-slate-700">Allocation Table</h4>
                            <button onclick="downloadPDF()" class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded hover:bg-slate-900">Download PDF</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm text-left" id="allocationTable">
                                <thead class="bg-slate-100 text-slate-600 text-xs uppercase font-bold">
                                    <tr>
                                        <th class="px-4 py-3">Date/Session</th>
                                        <th class="px-4 py-3">Team</th>
                                        <th class="px-4 py-3">QP Code</th>
                                        <th class="px-4 py-3 w-1/3">Register Nos</th>
                                        <th class="px-4 py-3 text-center">Count</th>
                                        <th class="px-4 py-3 text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="allocationBody" class="divide-y divide-slate-100"></tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="rosterModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-indigo-900 p-4 text-white flex justify-between items-center">
                <div><h3 class="text-lg font-bold" id="rosterModalTitle">QP Code: XXXX</h3></div>
                <div class="flex gap-3">
                    <button onclick="printRoster()" class="bg-indigo-600 hover:bg-indigo-700 px-3 py-1 rounded text-xs font-bold flex items-center gap-2"><i class="fas fa-print"></i> Print</button>
                    <button onclick="closeRosterModal()" class="text-indigo-300 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                </div>
            </div>
            <div class="p-0 overflow-y-auto flex-1 bg-slate-50"><div class="p-6"><table class="w-full text-sm text-left border-collapse" id="rosterTable"><thead><tr class="bg-slate-200 text-slate-700 text-xs uppercase"><th class="border border-slate-300 px-4 py-2 w-16 text-center">Sl. No</th><th class="border border-slate-300 px-4 py-2 w-48">Register Number</th><th class="border border-slate-300 px-4 py-2">Status</th></tr></thead><tbody class="bg-white text-slate-800"></tbody></table></div></div>
        </div>
    </div>

    <script>
        const facultyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQjBd_gzaBj1rb1CkdZFQxmMF6bWZDPqliMBwP78y09tsn30K5RpSOkTTDrwX-MXTccHVw4SUp2IND/pub?gid=0&single=true&output=csv';
        const studentCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZxWYeEtMHPaZdXLsccXu8igfnfVprxGK2IGzo7B9iEhMvDwWWZ9bxWfwQE3PIyuKZ203WTy84yh76/pub?gid=113708481&single=true&output=csv';
        const STORAGE_KEY = 'valuationBoardV34';

        // --- OPTIMIZED STATE ---
        let rawStudentData = []; // Full Data
        let facultyData = [];
        let studentsByDiscipline = {}; // Index: Discipline -> Array of Students
        let studentsByQP = {}; // Index: QP -> Array of Students (Sorted)
        let allocations = []; 
        let assignedRegs = new Set();
        let currentDiscipline = null;
        let saveTimeout = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadFacultyData();
            loadStudentData();
        });

        // --- DATA LOADING & INDEXING ---
        function loadFacultyData() {
            Papa.parse(facultyCsvUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => {
                    const nameKey = res.meta.fields.find(k => k.toUpperCase().includes('NAME'));
                    if(nameKey) facultyData = res.data.map(r => r[nameKey]).filter(n => n);
                    setupAutocomplete('chairmanNameInput', 'suggChairman', () => facultyData); // Setup Chairman Auto
                }
            });
        }

        function loadStudentData() {
            Papa.parse(studentCsvUrl, {
                download: true, header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                complete: (res) => {
                    if (!res.data || res.data.length === 0) return;
                    const keys = Object.keys(res.data[0]);
                    const findKey = (search) => keys.find(k => k.toUpperCase().replace(/\s/g, '') === search.toUpperCase());
                    
                    const k = {
                        qp: findKey('QPCODE') || 'QPCode',
                        reg: findKey('REGNO') || 'RegNo',
                        att: findKey('ATTENDANCE') || 'Attendance',
                        paper: findKey('PAPER') || 'Paper',
                        disc: findKey('DISCIPLINE') || 'Discipline'
                    };

                    // 1. Parse & Index in one pass
                    rawStudentData = [];
                    studentsByDiscipline = {};
                    studentsByQP = {};

                    res.data.forEach(row => {
                        const s = {
                            regNo: row[k.reg],
                            qp: row[k.qp] || 'UNKNOWN',
                            paperName: row[k.paper] || '',
                            discipline: row[k.disc] || 'Unknown',
                            attendance: (row[k.att] || '').toUpperCase()
                        };
                        
                        if(s.regNo && s.qp) {
                            rawStudentData.push(s);
                            
                            // Index by Discipline
                            if(!studentsByDiscipline[s.discipline]) studentsByDiscipline[s.discipline] = [];
                            studentsByDiscipline[s.discipline].push(s);

                            // Index by QP
                            if(!studentsByQP[s.qp]) studentsByQP[s.qp] = [];
                            studentsByQP[s.qp].push(s);
                        }
                    });

                    // 2. Sort QP Arrays once
                    Object.values(studentsByQP).forEach(list => list.sort((a,b) => a.regNo.localeCompare(b.regNo)));

                    initApp();
                },
                error: () => document.getElementById('connectionStatus').textContent = "Error Loading Data"
            });
        }

        function initApp() {
            document.getElementById('connectionStatus').textContent = "Connected";
            document.getElementById('connectionDot').className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
            
            // Setup Discipline Search
            const disciplines = Object.keys(studentsByDiscipline).sort();
            const discInput = document.getElementById('disciplineSearch');
            discInput.disabled = false;
            discInput.placeholder = "Search Discipline...";
            setupAutocomplete('disciplineSearch', 'disciplineSuggestions', () => disciplines, selectDiscipline);

            // Restore
            restoreState();
            
            // Setup Form Search (Dependent on selection)
            setupForm();
        }

        // --- AUTOCOMPLETE UTILS (DEBOUNCED & OPTIMIZED) ---
        function showSuggestions(list, input, container, callback) {
            container.innerHTML = ''; 
            if (!list || list.length === 0) { container.classList.add('hidden'); return; }
            
            // Limit render to 20 items for speed
            list.slice(0, 20).forEach(item => {
                const div = document.createElement('div'); 
                div.className = 'suggestion-item'; 
                div.textContent = item;
                div.onmousedown = (e) => { 
                    e.preventDefault(); 
                    callback(item); 
                    container.classList.add('hidden'); 
                }; 
                container.appendChild(div);
            });
            container.classList.remove('hidden');
        }

        function setupAutocomplete(inputId, listId, dataFn, onSelect) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);
            let debounceTimer;

            const handler = () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const val = input.value.toLowerCase();
                    if(val.length < 2 && inputId !== 'disciplineSearch') { list.classList.add('hidden'); return; } // Min chars optimization
                    
                    const data = dataFn(); // Get pre-calculated array
                    const matches = data.filter(d => d.toLowerCase().includes(val));
                    showSuggestions(matches, input, list, (sel) => {
                        input.value = sel;
                        if(onSelect) onSelect(sel);
                    });
                }, 200); // 200ms debounce
            };

            input.addEventListener('focus', () => { 
                const data = dataFn();
                showSuggestions(data, input, list, (sel) => {
                    input.value = sel;
                    if(onSelect) onSelect(sel);
                });
            });
            input.addEventListener('input', handler);
            input.addEventListener('blur', () => setTimeout(() => list.classList.add('hidden'), 200));
        }

        // --- CORE LOGIC ---
        function selectDiscipline(name) {
            document.getElementById('disciplineSearch').value = name;
            currentDiscipline = name;
            
            // Show Panel
            document.getElementById('planningPanel').classList.remove('hidden');
            
            // Update QP List source for Form
            updateDashboard();
            debounceSave();
        }

        function setupForm() {
            setupAutocomplete('allocChief', 'suggChief', () => facultyData);
            setupAutocomplete('allocAdditional', 'suggAdditional', () => facultyData);
            
            // QP Autocomplete - Use Pre-indexed Data
            const getQPs = () => {
                if(!currentDiscipline || !studentsByDiscipline[currentDiscipline]) return [];
                // Return unique QPs in this discipline
                const qps = new Set(studentsByDiscipline[currentDiscipline].map(s => `${s.qp} (${s.paperName.substring(0,25)}...)`));
                return [...qps].sort();
            };
            
            setupAutocomplete('allocQP', 'suggQP', getQPs, (val) => {
                // Auto-suggest next start reg
                updateStartRegSuggestion(val.split(' ')[0]); 
            });

            // Start Reg Autocomplete
            const getStartRegs = () => {
                const qpFull = document.getElementById('allocQP').value;
                const qp = qpFull.split(' ')[0];
                if(!qp || !studentsByQP[qp]) return [];
                // Filter only unassigned
                return studentsByQP[qp]
                    .filter(s => !assignedRegs.has(s.regNo))
                    .map(s => s.regNo);
            };
            setupAutocomplete('allocStartReg', 'suggStartReg', getStartRegs);
        }

        function updateStartRegSuggestion(qp) {
            if(!studentsByQP[qp]) return;
            const unassigned = studentsByQP[qp].find(s => !assignedRegs.has(s.regNo));
            
            const input = document.getElementById('allocStartReg');
            if(unassigned) {
                input.value = unassigned.regNo;
            } else {
                input.value = '';
                input.placeholder = "All Assigned";
            }
        }

        // --- ALLOCATION ---
        function addAllocation() {
            const date = document.getElementById('allocDate').value;
            const session = document.getElementById('allocSession').value;
            const chief = document.getElementById('allocChief').value;
            const additional = document.getElementById('allocAdditional').value;
            const qpFull = document.getElementById('allocQP').value;
            const startReg = document.getElementById('allocStartReg').value;
            const targetCount = parseInt(document.getElementById('allocCount').value) || 20;

            if(!date || !chief || !additional || !qpFull || !startReg) return alert("Please fill all fields");

            const qp = qpFull.split(' ')[0];
            const students = studentsByQP[qp]; // Use index!
            
            if(!students) return alert("Invalid QP Code");

            const startIndex = students.findIndex(s => s.regNo === startReg);
            if(startIndex === -1) return alert("Start Reg not found in this QP");

            let currentCount = 0;
            let bundleList = [];
            let i = startIndex;
            
            while(currentCount < targetCount && i < students.length) {
                const s = students[i];
                if(assignedRegs.has(s.regNo)) { i++; continue; } // Skip assigned

                const isAbsent = !s.attendance.includes('PRESENT');
                bundleList.push({ regNo: s.regNo, isAbsent: isAbsent, full: s.regNo }); 
                
                if(!isAbsent) currentCount++;
                i++;
            }

            if(bundleList.length === 0) return alert("No valid students found.");

            const newAlloc = {
                id: Date.now(), date, session, chief, additional, qp, fullPaperName: qpFull,
                startReg: bundleList[0].regNo, endReg: bundleList[bundleList.length - 1].regNo,
                count: currentCount, allRegs: bundleList
            };

            allocations.push(newAlloc);
            bundleList.forEach(b => assignedRegs.add(b.regNo));
            
            saveState(true); // Force save
            renderTable();
            updateDashboard();
            updateStartRegSuggestion(qp);
        }

        function deleteAllocation(id) {
            const alloc = allocations.find(a => a.id === id);
            if(!alloc) return;
            alloc.allRegs.forEach(b => assignedRegs.delete(b.regNo));
            allocations = allocations.filter(a => a.id !== id);
            saveState(true);
            renderTable();
            updateDashboard();
        }

        // --- DASHBOARD ---
        function updateDashboard() {
            const db = document.getElementById('statusDashboard');
            const totalCountEl = document.getElementById('totalPapersCount');
            
            if(!currentDiscipline || !studentsByDiscipline[currentDiscipline]) {
                db.innerHTML = `<div class="text-center text-slate-400 text-xs py-10">Select Discipline</div>`;
                return;
            }

            // Calc Stats
            const stats = {};
            studentsByDiscipline[currentDiscipline].forEach(s => {
                if(!stats[s.qp]) stats[s.qp] = { total: 0, assigned: 0, name: s.paperName };
                stats[s.qp].total++;
                if(assignedRegs.has(s.regNo)) stats[s.qp].assigned++;
            });

            // Render
            db.innerHTML = '';
            let qpCount = 0;
            Object.keys(stats).sort().forEach(qp => {
                qpCount++;
                const s = stats[qp];
                const remaining = s.total - s.assigned;
                const percent = s.total > 0 ? Math.round((s.assigned / s.total) * 100) : 0;
                const color = remaining === 0 ? 'text-green-600' : 'text-slate-700';
                
                const item = document.createElement('div');
                item.className = "bg-white p-3 rounded border border-slate-200 text-xs hover:border-indigo-300 transition-colors";
                item.innerHTML = `
                    <div class="flex justify-between font-bold ${color} items-start">
                        <div class="flex flex-col">
                            <span>${qp}</span>
                            <span class="text-[10px] font-normal text-slate-500 truncate w-32" title="${s.name}">${s.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>${remaining} Left</span>
                            <button onclick="viewRoster('${qp}')" class="text-indigo-500 hover:text-indigo-700 p-1" title="View Full Roster"><i class="fas fa-eye"></i></button>
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-1.5 mt-2">
                        <div class="bg-indigo-500 h-1.5 rounded-full" style="width: ${percent}%"></div>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1 text-right">${s.assigned} / ${s.total} Assigned</div>
                `;
                db.appendChild(item);
            });
            totalCountEl.textContent = `${qpCount} QP Codes`;
        }

        // --- RENDER TABLE ---
        function renderTable() {
            const tbody = document.getElementById('allocationBody');
            tbody.innerHTML = '';
            
            // Reverse chronological display (newest on top) or Sorted
            const sorted = [...allocations].sort((a,b) => {
                if(a.date !== b.date) return a.date.localeCompare(b.date);
                return a.session.localeCompare(b.session);
            });

            sorted.forEach(alloc => {
                const listHtml = generateSmartList(alloc.allRegs);
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 border-b border-slate-100 transition-colors";
                tr.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap"><div class="font-bold text-slate-800 text-xs">${formatDate(alloc.date)}</div><span class="text-[10px] bg-indigo-100 text-indigo-700 px-1.5 py-0.5 rounded">${alloc.session}</span></td>
                    <td class="px-4 py-3 text-xs"><div class="font-bold text-slate-700">${alloc.chief}</div><div class="text-slate-500">${alloc.additional}</div></td>
                    <td class="px-4 py-3 text-xs font-mono font-bold text-indigo-600">${alloc.qp}</td>
                    <td class="px-4 py-3 bg-slate-50 text-xs"><div class="reg-list">${listHtml}</div></td>
                    <td class="px-4 py-3 text-center font-bold text-green-600">${alloc.count}</td>
                    <td class="px-4 py-3 text-center"><button onclick="deleteAllocation(${alloc.id})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- HELPERS ---
        function generateSmartList(regsArray) {
            if(!regsArray) return '';
            const groups = [];
            const regex = /^([A-Z]+)(\d+)$/;
            regsArray.forEach(item => {
                const match = item.regNo.match(regex);
                const prefix = match ? match[1] : 'OTHER';
                const number = match ? match[2] : item.regNo;
                if (groups.length > 0 && groups[groups.length - 1].prefix === prefix) groups[groups.length - 1].items.push(item);
                else groups.push({ prefix, items: [item] });
            });
            return groups.map(group => {
                const nums = group.items.map((it, idx) => {
                    const match = it.regNo.match(regex);
                    let val = match ? match[2] : it.regNo;
                    if (idx === 0 && group.prefix !== 'OTHER') val = group.prefix + val;
                    if (it.isAbsent) return `<span class="absent">${val}(A)</span>`;
                    return val;
                }).join(', ');
                return `<div>${nums}</div>`;
            }).join('');
        }

        function generateSmartListText(regsArray) {
             const groups = [];
             const regex = /^([A-Z]+)(\d+)$/;
             regsArray.forEach(item => {
                const match = item.regNo.match(regex);
                const prefix = match ? match[1] : 'OTHER';
                if (groups.length > 0 && groups[groups.length - 1].prefix === prefix) groups[groups.length - 1].items.push(item);
                else groups.push({ prefix, items: [item] });
            });
            return groups.map(group => {
                return group.items.map((it, idx) => {
                    const match = it.regNo.match(regex);
                    let val = match ? match[2] : it.regNo;
                    if (idx === 0 && group.prefix !== 'OTHER') val = group.prefix + val;
                    if (it.isAbsent) return `${val}(A)`;
                    return val;
                }).join(', ');
            }).join('\n');
        }

        function formatDate(d) {
            if(!d) return '';
            const dt = new Date(d);
            return `${dt.getDate()}/${dt.getMonth()+1}`;
        }

        // --- PERSISTENCE ---
        function debounceSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveState, 500);
        }

        function saveState(immediate = false) {
            const state = {
                chairman: document.getElementById('chairmanNameInput').value,
                discipline: currentDiscipline,
                allocs: allocations
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            
            const indicator = document.getElementById('saveStatus');
            indicator.style.opacity = '1'; setTimeout(() => indicator.style.opacity = '0', 1000);
        }

        function restoreState() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if(!saved) return;
            try {
                const state = JSON.parse(saved);
                if(state.chairman) document.getElementById('chairmanNameInput').value = state.chairman;
                if(state.discipline) {
                    currentDiscipline = state.discipline;
                    document.getElementById('disciplineSearch').value = state.discipline;
                    document.getElementById('allocationPanel').classList.remove('hidden');
                }
                if(state.allocs) {
                    allocations = state.allocs;
                    // Rebuild assigned Set
                    assignedRegs = new Set();
                    allocations.forEach(a => a.allRegs.forEach(b => assignedRegs.add(b.regNo)));
                    renderTable();
                }
                updateDashboard(); // Initial dash
            } catch(e) {}
        }

        function clearSession() {
            if(confirm("Delete all allocations?")) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // --- ROSTER MODAL ---
        function viewRoster(qp) {
            const modal = document.getElementById('rosterModal');
            const title = document.getElementById('rosterModalTitle');
            const tbody = document.querySelector('#rosterTable tbody');
            const students = studentsByQP[qp]; 
            
            title.textContent = `QP Code: ${qp}`;
            tbody.innerHTML = '';
            let serial = 0;
            
            students.forEach(s => {
                const isAbsent = !s.attendance.includes('PRESENT');
                if(!isAbsent) serial++;
                const slNo = isAbsent ? '' : serial;
                const status = isAbsent ? '<span class="text-red-600 font-bold">ABSENT</span>' : '<span class="text-green-600">Present</span>';
                const regClass = isAbsent ? 'text-red-500 line-through' : 'font-mono font-bold';
                const rowClass = isAbsent ? 'bg-red-50' : '';

                tbody.innerHTML += `
                    <tr class="border-b border-slate-100 ${rowClass}">
                        <td class="border-r border-slate-300 px-4 py-2 text-center text-slate-500">${slNo}</td>
                        <td class="border-r border-slate-300 px-4 py-2 ${regClass}">${s.regNo}</td>
                        <td class="px-4 py-2 text-xs">${status}</td>
                    </tr>`;
            });
            modal.classList.remove('hidden');
        }
        function closeRosterModal() { document.getElementById('rosterModal').classList.add('hidden'); }
        function printRoster() {
            const content = document.getElementById('rosterTable').outerHTML;
            const title = document.getElementById('rosterModalTitle').textContent;
            const win = window.open('', '', 'width=800,height=600');
            win.document.write(`<html><head><title>${title}</title><style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:8px;text-align:left;}.text-red-600{color:red;font-weight:bold;}.line-through{text-decoration:line-through;}</style></head><body><h2>${title} - Master List</h2>${content}</body></html>`);
            win.document.close(); win.print();
        }

        // --- PDF ---
        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const chairman = document.getElementById('chairmanNameInput').value || 'TBA';
            
            const tableData = allocations.map(r => [
                r.date + '\n' + r.session,
                r.chief,
                r.additional,
                r.qp,
                generateSmartListText(r.allRegs),
                r.count
            ]);
            
            doc.setFillColor(30, 41, 59); doc.rect(0, 0, 210, 25, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16); doc.text("Valuation Board Allocation", 14, 16);
            doc.setFontSize(10); 
            doc.text(`Chairman: ${chairman}`, 14, 40);

            doc.setTextColor(0,0,0);
            doc.autoTable({
                head: [['Date/Session', 'Chief', 'Additional', 'QP Code', 'Register Nos', 'Count']],
                body: tableData,
                startY: 45, theme: 'grid',
                headStyles: { fillColor: [30, 41, 59] },
                styles: { fontSize: 8, cellPadding: 3, overflow: 'linebreak', valign: 'top' },
                columnStyles: { 
                    4: { cellWidth: 80 }
                }
            });
            doc.save(`Valuation_Plan.pdf`);
        }
    </script>
</body>
</html>
