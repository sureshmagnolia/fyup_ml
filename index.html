<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Sheet Generator V16 (Direct QP Code)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    spacing: { 'a4-w': '210mm', 'a4-h': '297mm' },
                    minHeight: { '5': '1.25rem' }
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', 'sans-serif'; }
        .page {
            width: var(--a4-width, 210mm);
            min-height: var(--a4-height, 297mm);
            padding: 4px 10mm 10mm 10mm;
            margin: 1rem auto;
            border: 1px solid #D3D3D3;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            color: #000;
        }
        .two-column-layout { display: flex; justify-content: space-between; width: 100%; height: 100%; }
        .mark-sheet-half { width: 49%; padding: 0 5mm; box-sizing: border-box; border-left: 1px dashed #aaa; }
        .mark-sheet-half:first-child { border-left: none; padding-left: 0; }
        .top-details-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5mm; font-size: 0.9rem; }
        .qp-code-top { font-weight: bold; }
        .copy-label-top { font-weight: bold; font-size: 1.1rem; }
        .page-header { text-align: center; margin-bottom: 0.1rem; }
        .page-header h3, .page-header h4 { margin: 0.25rem 0; font-weight: bold; }
        .paper-name-bar { text-align: center; margin: 5mm 0 2mm 0; }
        .paper-name-bar h5 { font-size: 0.8rem; font-weight: 500; }
        .mark-sheet-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.75rem; }
        .mark-sheet-table th, .mark-sheet-table td { border: 1px solid #000; padding: 0.3rem; text-align: left; }
        .mark-sheet-table th { background-color: #f4f4f4; font-weight: bold; }
        .marks-col { width: 25%; } .words-col { width: 45%; } .regno-col { width: 30%; }
        .signature-section { margin-top: 1.5rem; font-size: 0.75rem; page-break-inside: avoid; }
        .signature-block { margin-top: 1rem; }
        .examiner-name { margin-top: 0.1rem; font-weight: 500; }
        .examiner-designation { margin-top: 0.1rem; font-weight: 500; }
        .exam-details { display: flex; flex-direction: column; align-items: flex-end; margin-top: 0.5rem; font-size: 0.8rem; font-weight: 500; }
        
        /* Dropdowns */
        .autocomplete-container { position: relative; }
        .suggestions {
            position: absolute; z-index: 50; width: 100%; max-height: 200px; overflow-y: auto;
            background: white; border: 1px solid #ccc; border-top: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 0 0 6px 6px;
        }
        .suggestion-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: #f0f0f0; }
        .hidden { display: none; }

        /* Entry Table */
        #marksEntryArea table { width: 100%; border-collapse: collapse; }
        #marksEntryArea th, #marksEntryArea td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #marksEntryArea input, .form-section input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 3px; }
        #marksEntryArea input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        #marksTableContainer { max-height: 60vh; overflow-y: auto; position: relative; border: 1px solid #e5e7eb; border-radius: 6px; }
        #marksEntryArea thead th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; border-bottom: 2px solid #ddd; }
        
        /* Print */
        @media print {
            body { background-color: #fff !important; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            .container-wrapper, #outputArea { box-shadow: none; margin: 0; padding: 0; border: 0; }
            .page { width: 100%; height: auto; margin: 0; border: 0; box-shadow: none; padding: 4px 10mm 10mm 10mm; page-break-after: always; }
            .mark-sheet-half:not(:first-child) { border-left: 1px dashed #000 !important; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container-wrapper max-w-6xl mx-auto p-6 md:p-8 bg-white rounded-2xl shadow-lg">
        <header class="no-print mb-6 pb-4 border-b border-gray-200 flex items-center gap-4">
            <svg class="w-10 h-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div>
                <h1 class="text-3xl font-bold text-indigo-700">Mark Sheet Generator (V16)</h1>
                <p class="text-gray-600 mt-1">Integrated Absent Management & Direct QP Code Support</p>
            </div>
        </header>
        
        <div id="loaderContainer" class="loader-container no-print mb-6 p-4 rounded-lg bg-gray-50 border border-gray-200">
            <div id="loadingText" class="loading-text text-sm font-semibold mb-2 text-gray-700">Connecting to database...</div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="loaderBar" class="h-2 bg-blue-500 rounded-full transition-all duration-300" style="width: 10%"></div>
            </div>
        </div>

        <fieldset id="mainForm" disabled>
            <div class="form-section no-print mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 1: Select Exam & Range</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="form-group md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">QP Code (Searchable)</label>
                        <div class="autocomplete-container">
                            <input type="text" id="qpCodeInput" placeholder="Type 3+ letters..." class="mt-1 block w-full py-2 px-3">
                            <div id="qpCodeSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Paper Name</label>
                        <input type="text" id="courseName" readonly class="mt-1 block w-full py-2 px-3 bg-gray-50">
                    </div>
                </div>
                <hr class="my-6 border-gray-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="form-group md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Date of Entry</label>
                        <input type="date" id="markEntryDate" class="mt-1 block w-full py-2 px-3">
                    </div>
                    <div class="form-group md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Session</label>
                        <div class="autocomplete-container">
                            <input type="text" id="valuationSession" placeholder="FN / AN" class="mt-1 block w-full py-2 px-3">
                            <div id="valuationSessionSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                    <div class="form-group md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">Start Register No</label>
                        <div class="autocomplete-container">
                            <input type="text" id="startRegNo" placeholder="Select QP First" class="mt-1 block w-full py-2 px-3">
                            <div id="startRegNoSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                    <div class="form-group md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700">End Register No</label>
                        <div class="autocomplete-container">
                            <input type="text" id="endRegNo" placeholder="To Reg No" class="mt-1 block w-full py-2 px-3">
                            <div id="endRegNoSuggestions" class="suggestions hidden"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-section no-print mb-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 2: Assign Examiners</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Additional Examiner</label>
                        <div class="autocomplete-container">
                            <input type="text" id="additionalExaminerName" placeholder="Search..." class="mt-1 block w-full py-2 px-3">
                            <div id="additionalExaminerSuggestions" class="suggestions hidden"></div>
                        </div>
                        <input type="text" id="additionalExaminerDesignation" readonly class="mt-2 block w-full py-2 px-3 bg-gray-50 text-xs">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Chief Examiner</label>
                        <div class="autocomplete-container">
                            <input type="text" id="chiefExaminerName" placeholder="Search..." class="mt-1 block w-full py-2 px-3">
                            <div id="chiefExaminerSuggestions" class="suggestions hidden"></div>
                        </div>
                        <input type="text" id="chiefExaminerDesignation" readonly class="mt-2 block w-full py-2 px-3 bg-gray-50 text-xs">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Chairman</label>
                        <div class="autocomplete-container">
                            <input type="text" id="chairmanName" placeholder="Search..." class="mt-1 block w-full py-2 px-3">
                            <div id="chairmanSuggestions" class="suggestions hidden"></div>
                        </div>
                        <input type="text" id="chairmanDesignation" readonly class="mt-2 block w-full py-2 px-3 bg-gray-50 text-xs">
                    </div>
                </div>
            </div>
            
            <div class="no-print mt-6 flex gap-4">
                <button id="loadRollButton" class="py-2 px-5 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition-colors">
                    Load Nominal Roll
                </button>
                <button id="resetButton" class="py-2 px-5 bg-red-600 text-white font-semibold rounded-lg shadow hover:bg-red-700 transition-colors">
                    Reset
                </button>
            </div>
            
            <div id="messageBox" class="hidden no-print mt-4 p-4 rounded-md text-sm"></div>

            <div id="marksEntryArea" class="hidden form-section no-print mt-8 p-5 border border-dashed border-gray-300 rounded-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Step 3: Enter Marks</h2>
                <div id="marksTableContainer"></div>
                <button id="generateButton" class="mt-4 py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors">
                    Generate Printable Mark Sheet
                </button>
            </div>
        </fieldset>

        <div id="outputArea" class="mt-8 border-t border-gray-200 pt-8">
            <div class="no-print mx-auto flex gap-4 justify-center">
                <button id="printButton" class="hidden py-2 px-5 bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition-colors">
                    Download PDF
                </button>
                <button id="printPageButton" class="hidden py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors">
                    Print
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Libraries ---
        const { jsPDF } = window.jspdf;
        const html2canvas = window.html2canvas;

        // --- Config & State ---
        const studentCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZxWYeEtMHPaZdXLsccXu8igfnfVprxGK2IGzo7B9iEhMvDwWWZ9bxWfwQE3PIyuKZ203WTy84yh76/pub?gid=113708481&single=true&output=csv';
        const facultyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQjBd_gzaBj1rb1CkdZFQxmMF6bWZDPqliMBwP78y09tsn30K5RpSOkTTDrwX-MXTccHVw4SUp2IND/pub?gid=0&single=true&output=csv';
        const LOCAL_STORAGE_KEY = 'marksheetFormData_V16';

        let studentData = [], facultyData = [], qpCodeList = [], currentNominalRoll = [];
        let dataLoadedCount = 0;

        // --- DOM Elements ---
        const els = {
            qpCode: document.getElementById('qpCodeInput'),
            course: document.getElementById('courseName'),
            startReg: document.getElementById('startRegNo'),
            endReg: document.getElementById('endRegNo'),
            date: document.getElementById('markEntryDate'),
            session: document.getElementById('valuationSession'),
            addl: document.getElementById('additionalExaminerName'),
            chief: document.getElementById('chiefExaminerName'),
            chair: document.getElementById('chairmanName'),
            msg: document.getElementById('messageBox'),
            form: document.getElementById('mainForm'),
            loader: document.getElementById('loaderBar'),
            entryArea: document.getElementById('marksEntryArea'),
            output: document.getElementById('outputArea'),
            tableContainer: document.getElementById('marksTableContainer')
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData(studentCsvUrl, 'student');
            loadData(facultyCsvUrl, 'faculty');
            setupAutocompletes();
            loadFormData();
        });

        // --- Data Loading ---
        function loadData(url, type) {
            Papa.parse(url, {
                download: true, header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                complete: (res) => {
                    if (type === 'student') processStudents(res.data);
                    else processFaculty(res.data);
                    checkLoad();
                }
            });
        }

        function processStudents(data) {
            studentData = data.map(row => {
                // UPDATE: Get QP Code directly from Column G ('QPCode')
                const qp = row['QPCode'] || '';
                return {
                    regNo: row['RegNo'],
                    name: row['Name'],
                    paper: row['Paper'] || '',
                    qpCode: qp,
                    attendance: (row['Attendance'] || '').toUpperCase()
                };
            }).filter(s => s.regNo && s.qpCode);
            
            // Build unique list
            qpCodeList = [...new Set(studentData.map(s => s.qpCode))].sort();
        }

        function processFaculty(data) {
            const nameKey = data[0] && Object.keys(data[0]).find(k => k.toUpperCase().includes('NAME')) || 'NAME';
            const desigKey = data[0] && Object.keys(data[0]).find(k => k.toUpperCase().includes('DESIGNATION')) || 'Designation';
            facultyData = data.map(row => ({ name: row[nameKey], designation: row[desigKey] || '' })).filter(f => f.name);
        }

        function checkLoad() {
            dataLoadedCount++;
            els.loader.style.width = `${dataLoadedCount * 50}%`;
            if (dataLoadedCount === 2) {
                document.getElementById('loadingText').textContent = "Ready";
                els.form.disabled = false;
                els.loader.classList.replace('bg-blue-500', 'bg-green-500');
                setTimeout(() => document.getElementById('loaderContainer').style.display = 'none', 500);
            }
        }

        // --- Logic: Load Roll ---
        document.getElementById('loadRollButton').addEventListener('click', () => {
            const qp = els.qpCode.value.trim();
            const start = els.startReg.value.trim();
            const end = els.endReg.value.trim();

            if (!qp || !start || !end) return showMsg('Please select QP Code, Start Reg, and End Reg.', 'error');

            const filtered = studentData.filter(s => s.qpCode === qp).sort((a,b) => a.regNo.localeCompare(b.regNo));
            const startIdx = filtered.findIndex(s => s.regNo === start);
            const endIdx = filtered.findIndex(s => s.regNo === end);

            if (startIdx === -1 || endIdx === -1 || startIdx > endIdx) {
                return showMsg('Invalid Register Number range selected.', 'error');
            }

            // Slice Inclusive
            currentNominalRoll = filtered.slice(startIdx, endIdx + 1);
            
            generateEntryTable();
            saveFormData();
            els.entryArea.classList.remove('hidden');
            document.getElementById('markSheetPage')?.remove();
            showMsg(`Loaded ${currentNominalRoll.length} students (including absents).`, 'success');
        });

        function generateEntryTable() {
            const savedMarks = loadFormData() || {};
            let html = `<table class="w-full">
                <thead class="bg-gray-50"><tr><th class="w-10">#</th><th>Reg No</th><th>Status</th><th>Marks (Max 100)</th></tr></thead><tbody>`;
            
            currentNominalRoll.forEach((s, i) => {
                const isAbsent = s.attendance.includes('ABSENT');
                const saved = savedMarks[s.regNo] || '';
                const val = isAbsent ? 'Absent' : saved;
                const readOnly = isAbsent ? 'readonly' : '';
                const statusClass = isAbsent ? 'text-red-600 font-bold' : 'text-green-600';
                const inputClass = isAbsent ? 'bg-gray-100 text-red-600 font-bold cursor-not-allowed' : 'bg-white';

                html += `<tr>
                    <td>${i + 1}</td>
                    <td class="font-mono font-bold">${s.regNo}</td>
                    <td class="${statusClass} text-xs">${s.attendance}</td>
                    <td>
                        <input type="text" 
                            class="marks-input ${inputClass} border p-1 rounded w-full" 
                            data-reg="${s.regNo}" 
                            value="${val}" 
                            ${readOnly} 
                            oninput="validateMark(this); saveFormData()"
                        >
                    </td>
                </tr>`;
            });
            html += `</tbody></table>`;
            els.tableContainer.innerHTML = html;
        }

        window.validateMark = (input) => {
            if (input.value.toUpperCase() === 'ABSENT') return;
            const val = parseInt(input.value);
            if (val > 100) { input.value = ''; showMsg("Max mark is 100", 'error'); }
        };

        // --- Logic: Output Generation ---
        document.getElementById('generateButton').addEventListener('click', () => {
            const marksMap = {};
            let valid = true;
            
            document.querySelectorAll('.marks-input').forEach(inp => {
                const val = inp.value.trim();
                if (!val) valid = false;
                marksMap[inp.dataset.reg] = val;
            });

            if (!valid) return showMsg("Please enter marks for all students.", 'error');

            const html = `
                <div class="page" id="markSheetPage">
                    <div class="two-column-layout">
                        <div class="mark-sheet-half">${createSheet(marksMap, 'ORIGINAL')}</div>
                        <div class="mark-sheet-half">${createSheet(marksMap, 'DUPLICATE')}</div>
                    </div>
                </div>`;
            
            document.getElementById('markSheetPage')?.remove();
            els.output.insertAdjacentHTML('beforeend', html);
            document.getElementById('printButton').classList.remove('hidden');
            document.getElementById('printPageButton').classList.remove('hidden');
            showMsg("Sheet generated.", 'success');
        });

        function createSheet(marksMap, type) {
            const rows = currentNominalRoll.map(s => {
                const mark = marksMap[s.regNo];
                let words = '';
                
                if (mark.toUpperCase() === 'ABSENT') {
                    words = 'Absent';
                } else {
                    words = numberToWords(mark);
                }

                return `<tr>
                    <td class="regno-col">${s.regNo}</td>
                    <td class="marks-col text-center">${mark}</td>
                    <td class="words-col text-xs">${words}</td>
                </tr>`;
            }).join('');

            return `
                <div class="top-details-bar">
                    <span class="qp-code-top">${els.qpCode.value}</span>
                    <span class="copy-label-top">${type}</span>
                </div>
                <div class="page-header">
                    <h4 class="text-sm">UNIVERSITY OF CALICUT</h4>
                    <h4 class="text-sm">MARK SHEET</h4>
                </div>
                <div class="paper-name-bar"><h5 class="text-xs font-semibold">${els.course.value}</h5></div>
                <table class="mark-sheet-table">
                    <thead><tr><th>Reg No</th><th>Marks</th><th>In Words</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="signature-section">
                    <div class="signature-block"><strong>Addl. Examiner</strong><div class="examiner-name min-h-5 pt-4">${els.addl.value}</div><div class="min-h-5 border-b border-dotted border-gray-400"></div></div>
                    <div class="signature-block"><strong>Chief Examiner</strong><div class="examiner-name min-h-5 pt-4">${els.chief.value}</div><div class="min-h-5 border-b border-dotted border-gray-400"></div></div>
                    <div class="signature-block"><strong>Chairman</strong><div class="examiner-name min-h-5 pt-4">${els.chair.value}</div><div class="min-h-5 border-b border-dotted border-gray-400"></div></div>
                </div>
                <div class="exam-details mt-4"><div>${formatDate(els.date.value)} ${els.session.value}</div></div>
            `;
        }

        // --- Helpers ---
        function numberToWords(numStr) {
            if (!numStr) return '';
            const digitMap = { '0': 'Zero', '1': 'One', '2': 'Two', '3': 'Three', '4': 'Four', '5': 'Five', '6': 'Six', '7': 'Seven', '8': 'Eight', '9': 'Nine' };
            return numStr.split('').map(d => digitMap[d] || '').join(' ');
        }

        function formatDate(d) {
            if (!d) return '';
            const [y, m, day] = d.split('-');
            return `${day}/${m}/${y.slice(2)}`;
        }

        function showMsg(msg, type) {
            els.msg.textContent = msg;
            els.msg.className = `no-print mt-4 p-4 rounded-md text-sm ${type === 'error' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
            els.msg.classList.remove('hidden');
        }

        // --- Autocomplete Setup ---
        function setupAutocompletes() {
            setupAC(els.qpCode, document.getElementById('qpCodeSuggestions'), () => qpCodeList, (val) => {
                const paper = studentData.find(s => s.qpCode === val)?.paper;
                els.course.value = paper || '';
                els.startReg.value = ''; els.endReg.value = '';
            });

            // Start Reg Filter
            setupAC(els.startReg, document.getElementById('startRegNoSuggestions'), () => {
                const qp = els.qpCode.value;
                return studentData.filter(s => s.qpCode === qp).map(s => s.regNo).sort();
            });

            // End Reg Filter (Show only regs >= start)
            setupAC(els.endReg, document.getElementById('endRegNoSuggestions'), () => {
                const qp = els.qpCode.value;
                const start = els.startReg.value;
                return studentData.filter(s => s.qpCode === qp && s.regNo >= start).map(s => s.regNo).sort();
            });

            // Faculty
            const facSource = () => facultyData.map(f => f.name);
            setupAC(els.addl, document.getElementById('additionalExaminerSuggestions'), facSource, (v) => setDesig(v, 'additionalExaminerDesignation'));
            setupAC(els.chief, document.getElementById('chiefExaminerSuggestions'), facSource, (v) => setDesig(v, 'chiefExaminerDesignation'));
            setupAC(els.chair, document.getElementById('chairmanSuggestions'), facSource, (v) => setDesig(v, 'chairmanDesignation'));
            
            // Session
            setupAC(els.session, document.getElementById('valuationSessionSuggestions'), () => ['FN', 'AN']);
        }

        function setupAC(input, listEl, sourceFn, onSelect) {
            input.addEventListener('input', () => {
                const val = input.value.toUpperCase();
                if (val.length < 1) return listEl.classList.add('hidden');
                const matches = sourceFn().filter(x => x.toUpperCase().includes(val)).slice(0, 10);
                listEl.innerHTML = matches.map(m => `<div class="suggestion-item">${m}</div>`).join('');
                listEl.classList.remove('hidden');
                
                listEl.querySelectorAll('.suggestion-item').forEach(div => {
                    div.onclick = () => {
                        input.value = div.textContent;
                        listEl.classList.add('hidden');
                        if (onSelect) onSelect(div.textContent);
                        saveFormData();
                    };
                });
            });
            document.addEventListener('click', e => { if (!input.contains(e.target)) listEl.classList.add('hidden'); });
        }

        function setDesig(name, id) {
            const f = facultyData.find(x => x.name === name);
            if (f) document.getElementById(id).value = f.designation;
        }

        // --- Storage ---
        function saveFormData() {
            const data = {
                qp: els.qpCode.value, start: els.startReg.value, end: els.endReg.value,
                date: els.date.value, sess: els.session.value,
                addl: els.addl.value, chief: els.chief.value, chair: els.chair.value,
                marks: {}
            };
            document.querySelectorAll('.marks-input').forEach(i => data.marks[i.dataset.reg] = i.value);
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
        }

        function loadFormData() {
            try {
                const data = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                if (!data) return;
                els.qpCode.value = data.qp || ''; 
                els.date.value = data.date || ''; els.session.value = data.sess || '';
                els.addl.value = data.addl || ''; els.chief.value = data.chief || ''; els.chair.value = data.chair || '';
                
                // Trigger course update if qp exists
                if (data.qp && dataLoadedCount === 2) {
                    const paper = studentData.find(s => s.qpCode === data.qp)?.paper;
                    els.course.value = paper || '';
                }
                
                els.startReg.value = data.start || ''; els.endReg.value = data.end || '';
                if(data.addl) setDesig(data.addl, 'additionalExaminerDesignation');
                if(data.chief) setDesig(data.chief, 'chiefExaminerDesignation');
                if(data.chair) setDesig(data.chair, 'chairmanDesignation');
                
                return data.marks;
            } catch(e) {}
        }

        // --- Print/PDF ---
        document.getElementById('printButton').addEventListener('click', async () => {
            const element = document.getElementById('markSheetPage');
            const canvas = await html2canvas(element, { scale: 2 });
            const imgData = canvas.toDataURL('image/jpeg', 0.98);
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            pdf.addImage(imgData, 'JPEG', 0, 0, 210, 297);
            pdf.save('mark-sheet.pdf');
        });
        
        document.getElementById('printPageButton').addEventListener('click', () => window.print());
        document.getElementById('resetButton').addEventListener('click', () => {
            if(confirm("Clear all data?")) { localStorage.removeItem(LOCAL_STORAGE_KEY); location.reload(); }
        });

    </script>
</body>
</html>
