<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Board Manager - Chairman's Module</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.6.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Autocomplete Styles */
        .autocomplete-container { position: relative; }
        .suggestions {
            position: absolute; z-index: 50; width: 100%; max-height: 200px;
            overflow-y: auto; background: white; border: 1px solid #ccc;
            border-radius: 0 0 4px 4px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .suggestion-item { padding: 8px 12px; cursor: pointer; font-size: 0.9rem; }
        .suggestion-item:hover { background-color: #f3f4f6; }
        .hidden { display: none; }
        
        /* Loading Bar Animation */
        .loader-bar { height: 4px; width: 100%; background-color: #e5e7eb; border-radius: 2px; overflow: hidden; }
        .loader-progress { height: 100%; background-color: #4f46e5; width: 0%; transition: width 0.5s ease; }
        .loader-progress.indeterminate { width: 50%; animation: slide 1.5s infinite ease-in-out; }
        @keyframes slide { 0% { transform: translateX(-100%); } 100% { transform: translateX(200%); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">

    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-indigo-800 p-6 text-white flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold"><i class="fas fa-graduation-cap mr-2"></i>Valuation Board Manager</h1>
                <p class="text-indigo-200 text-sm mt-1">Discipline-wise Paper Distribution & Session Management</p>
            </div>
            <div class="text-right">
                <span class="bg-indigo-600 px-3 py-1 rounded text-xs font-mono">CHAIRMAN MODULE</span>
                <div class="text-xs text-indigo-300 mt-1" id="connectionStatus">Connecting...</div>
            </div>
        </div>

        <div class="p-6 space-y-8">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 border-b border-gray-200 pb-6">
                
                <div class="bg-blue-50 p-5 rounded-lg border border-blue-100 col-span-2">
                    <h3 class="font-semibold text-gray-800 mb-4 border-b border-blue-200 pb-2">1. Select Discipline Board</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Filter by Discipline</label>
                            <div class="autocomplete-container">
                                <div class="relative">
                                    <span class="absolute inset-y-0 left-0 flex items-center pl-2 text-gray-400">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" id="disciplineSearch" placeholder="Type to search (e.g. Tamil...)" class="w-full border border-blue-300 rounded pl-8 p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-all" disabled>
                                </div>
                                <div id="disciplineSuggestions" class="suggestions hidden"></div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Valuation Quota Rule</label>
                            <div class="flex gap-3">
                                <label class="flex-1 flex items-center justify-center space-x-2 cursor-pointer bg-white px-3 py-2 rounded border border-blue-200 shadow-sm hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                                    <input type="radio" name="quotaRule" value="ARTS" class="form-radio text-indigo-600 h-4 w-4" checked onchange="updateEstimates()">
                                    <div>
                                        <span class="font-bold text-gray-800 text-sm block">Arts</span>
                                        <span class="text-[10px] text-gray-500">FN:20 / AN:15</span>
                                    </div>
                                </label>
                                <label class="flex-1 flex items-center justify-center space-x-2 cursor-pointer bg-white px-3 py-2 rounded border border-blue-200 shadow-sm hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                                    <input type="radio" name="quotaRule" value="SCIENCE" class="form-radio text-indigo-600 h-4 w-4" onchange="updateEstimates()">
                                    <div>
                                        <span class="font-bold text-gray-800 text-sm block">Science</span>
                                        <span class="text-[10px] text-gray-500">FN:18 / AN:12</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 flex flex-col justify-center">
                    <h3 class="font-semibold text-gray-700 mb-3 border-b border-gray-200 pb-2">System Status</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span><i class="fas fa-database mr-1"></i> Student DB</span>
                                <span id="studentLoadStatus" class="font-bold text-orange-500">Connecting...</span>
                            </div>
                            <div class="loader-bar"><div id="studentLoader" class="loader-progress indeterminate"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1">
                                <span><i class="fas fa-users mr-1"></i> Faculty DB</span>
                                <span id="facultyLoadStatus" class="font-bold text-orange-500">Connecting...</span>
                            </div>
                            <div class="loader-bar"><div id="facultyLoader" class="loader-progress indeterminate"></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="planningSection" class="hidden animate-fade-in-down">
                
                <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 mb-6 flex flex-wrap justify-between items-center shadow-sm">
                    <div>
                        <h2 class="text-xl font-bold text-indigo-800" id="selectedDisciplineTitle">Discipline Name</h2>
                        <div class="text-sm text-indigo-600 mt-1">
                            <span class="mr-4"><i class="fas fa-copy mr-1"></i> Papers: <span id="summaryPaperCount" class="font-bold">0</span></span>
                            <span><i class="fas fa-file-alt mr-1"></i> Total Present Scripts: <span id="summaryScriptCount" class="font-bold text-lg">0</span></span>
                        </div>
                    </div>
                    <div class="text-right mt-2 md:mt-0">
                        <div class="text-xs text-gray-500 uppercase font-bold">Estimated Duration</div>
                        <div class="text-2xl font-bold text-gray-800" id="estimatedDaysDisplay">0 Days</div>
                        <div class="text-xs text-gray-500" id="capacityDisplay">with current team</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5">
                        <h4 class="font-bold text-gray-800 border-b pb-2 mb-4"><i class="fas fa-chalkboard-teacher mr-2 text-indigo-500"></i>Examiner Team</h4>
                        
                        <div class="mb-4">
                            <label class="block text-xs font-bold text-gray-500 mb-1">CHIEF EXAMINER</label>
                            <div class="autocomplete-container">
                                <input type="text" id="chiefInput" placeholder="Search Chief Examiner..." class="w-full border rounded p-2 text-sm bg-gray-50 focus:bg-white transition-colors outline-none focus:ring-2 focus:ring-indigo-500">
                                <div id="chiefSuggestions" class="suggestions hidden"></div>
                            </div>
                        </div>

                        <div class="mb-2">
                            <label class="block text-xs font-bold text-gray-500 mb-1">ADDITIONAL EXAMINERS (TEAM)</label>
                            <div class="flex gap-2 mb-2">
                                <div class="autocomplete-container flex-1">
                                    <input type="text" id="addlInput" placeholder="Search & Add Examiner..." class="w-full border rounded p-2 text-sm outline-none focus:ring-2 focus:ring-indigo-500">
                                    <div id="addlSuggestions" class="suggestions hidden"></div>
                                </div>
                                <button onclick="addExaminer()" class="bg-indigo-600 text-white px-4 rounded hover:bg-indigo-700 transition-colors">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded border border-gray-200 h-48 overflow-y-auto p-2" id="examinerListContainer">
                            <div class="text-center text-gray-400 text-xs mt-4 italic">No additional examiners added yet.</div>
                        </div>
                        <div class="text-right mt-2 text-xs text-gray-500">
                            Total Additional: <span id="teamSizeCount" class="font-bold text-indigo-600">0</span>
                        </div>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-5">
                        <h4 class="font-bold text-gray-800 border-b pb-2 mb-4"><i class="far fa-calendar-alt mr-2 text-indigo-500"></i>Session Calendar</h4>
                        
                        <div class="bg-yellow-50 p-3 rounded text-xs text-yellow-800 mb-4 flex items-start">
                            <i class="fas fa-info-circle mt-0.5 mr-2"></i>
                            <div>The system calculated the days based on your Team Size. Please map specific dates below.</div>
                        </div>

                        <div id="dateMappingContainer" class="max-h-60 overflow-y-auto space-y-2 pr-2">
                            <div class="text-center text-gray-400 text-sm py-8">Select Discipline and Add Examiners to generate schedule.</div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-3 pt-6 border-t border-gray-100">
                    <button onclick="generatePlan()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded shadow-md font-medium text-sm transition-all flex items-center">
                        <i class="fas fa-table mr-2"></i> Generate Distribution Table
                    </button>
                </div>
            </div>

            <div id="outputSection" class="hidden mt-8 animate-fade-in-up">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="font-bold text-xl text-gray-800">Distribution Plan</h3>
                    <button onclick="downloadPDF()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm hover:bg-gray-900 transition-colors shadow-sm">
                        <i class="fas fa-file-pdf mr-2"></i> Download PDF
                    </button>
                </div>
                
                <div class="overflow-x-auto border rounded-lg shadow-lg">
                    <table class="min-w-full text-sm text-left" id="distributionTable">
                        <thead class="bg-gray-800 text-white text-xs uppercase tracking-wider">
                            <tr>
                                <th class="px-4 py-3">Date / Session</th>
                                <th class="px-4 py-3">Examiner</th>
                                <th class="px-4 py-3">Paper Code</th>
                                <th class="px-4 py-3">RegNo Range</th>
                                <th class="px-4 py-3 text-center">Scripts</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200 text-gray-700">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Constants & State ---
        const facultyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSQjBd_gzaBj1rb1CkdZFQxmMF6bWZDPqliMBwP78y09tsn30K5RpSOkTTDrwX-MXTccHVw4SUp2IND/pub?gid=0&single=true&output=csv';
        const studentCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTZxWYeEtMHPaZdXLsccXu8igfnfVprxGK2IGzo7B9iEhMvDwWWZ9bxWfwQE3PIyuKZ203WTy84yh76/pub?gid=113708481&single=true&output=csv';
        
        let rawStudentData = [];
        let facultyData = [];
        let disciplineList = [];
        
        // Planning State
        let currentDiscipline = null;
        let pooledStudents = []; // All students in selected discipline
        let additionalExaminers = []; // List of selected examiner objects {name, desig}
        let generatedPlan = [];
        
        // Rules
        const RULES = {
            ARTS: { FN: 20, AN: 15 },
            SCIENCE: { FN: 18, AN: 12 }
        };

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadFacultyData();
            loadStudentData();
        });

        // --- Data Loading ---
        function loadFacultyData() {
            Papa.parse(facultyCsvUrl, {
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => {
                    facultyData = res.data.map(r => ({
                        name: r['NAME'] || r['Name'], 
                        designation: r['Designation of Faculty'] || ''
                    })).filter(f => f.name);
                    updateStatus('faculty', true, `Ready (${facultyData.length} records)`);
                },
                error: () => updateStatus('faculty', false, "Failed")
            });
        }

        function loadStudentData() {
            Papa.parse(studentCsvUrl, {
                download: true, header: true, skipEmptyLines: true, transformHeader: h => h.trim(),
                complete: (res) => {
                    rawStudentData = res.data;
                    extractDisciplines();
                    updateStatus('student', true, `Ready (${rawStudentData.length} records)`);
                    document.getElementById('connectionStatus').textContent = "Connected";
                    document.getElementById('connectionStatus').className = "text-xs text-green-300 mt-1";
                },
                error: () => updateStatus('student', false, "Failed")
            });
        }

        function updateStatus(type, success, msg) {
            const el = document.getElementById(`${type}LoadStatus`);
            const bar = document.getElementById(`${type}Loader`);
            el.textContent = msg;
            el.className = success ? "font-bold text-green-600" : "font-bold text-red-600";
            bar.className = "loader-progress";
            bar.style.width = success ? "100%" : "0%";
            bar.style.backgroundColor = success ? "#10b981" : "#ef4444";
        }

        // --- Discipline Handling ---
        function extractDisciplines() {
            const unique = new Set(rawStudentData.map(r => r.Discipline).filter(Boolean));
            disciplineList = Array.from(unique).sort();
            
            const input = document.getElementById('disciplineSearch');
            input.disabled = false;
            
            const suggestions = document.getElementById('disciplineSuggestions');
            input.addEventListener('focus', () => showSuggestions(disciplineList, input, suggestions, selectDiscipline));
            input.addEventListener('input', () => {
                const val = input.value.toLowerCase();
                const filtered = disciplineList.filter(d => d.toLowerCase().includes(val));
                showSuggestions(filtered, input, suggestions, selectDiscipline);
            });
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) suggestions.classList.add('hidden');
            });
        }

        function selectDiscipline(name) {
            document.getElementById('disciplineSearch').value = name;
            currentDiscipline = name;
            
            // 1. Filter Data
            const disciplineRows = rawStudentData.filter(r => r.Discipline === name);
            
            // 2. Sort: By Paper Name, then by Register Number
            pooledStudents = disciplineRows.sort((a, b) => {
                if (a.Paper === b.Paper) {
                    return (a.RegNo || '').localeCompare(b.RegNo || '');
                }
                return (a.Paper || '').localeCompare(b.Paper || '');
            });

            // 3. Calc Stats
            const papers = new Set(pooledStudents.map(s => s.Paper));
            const presentCount = pooledStudents.filter(s => (s.Attendance || '').toUpperCase().includes('PRESENT')).length;

            // 4. Update UI
            document.getElementById('planningSection').classList.remove('hidden');
            document.getElementById('selectedDisciplineTitle').textContent = name;
            document.getElementById('summaryPaperCount').textContent = papers.size;
            document.getElementById('summaryScriptCount').textContent = presentCount;
            
            updateEstimates();
        }

        // --- Team Management ---
        // Setup Search
        const addlInput = document.getElementById('addlInput');
        const addlSugg = document.getElementById('addlSuggestions');
        addlInput.addEventListener('input', () => {
            const val = addlInput.value.toLowerCase();
            if(val.length < 3) { addlSugg.classList.add('hidden'); return; }
            const matches = facultyData.filter(f => f.name.toLowerCase().includes(val)).slice(0, 8);
            
            addlSugg.innerHTML = '';
            matches.forEach(f => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = f.name;
                div.onclick = () => { addlInput.value = f.name; addlInput.dataset.desig = f.designation; addlSugg.classList.add('hidden'); };
                addlSugg.appendChild(div);
            });
            addlSugg.classList.remove('hidden');
        });

        function addExaminer() {
            const name = addlInput.value.trim();
            if(!name) return;
            const desig = addlInput.dataset.desig || '';
            
            additionalExaminers.push({ name, designation: desig });
            addlInput.value = ''; // Clear
            renderExaminerList();
            updateEstimates();
        }

        function removeExaminer(idx) {
            additionalExaminers.splice(idx, 1);
            renderExaminerList();
            updateEstimates();
        }

        function renderExaminerList() {
            const container = document.getElementById('examinerListContainer');
            document.getElementById('teamSizeCount').textContent = additionalExaminers.length;
            
            if(additionalExaminers.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 text-xs mt-4 italic">No additional examiners added yet.</div>';
                return;
            }
            
            container.innerHTML = '';
            additionalExaminers.forEach((ex, idx) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-2 mb-1 border rounded shadow-sm text-sm';
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800">${ex.name}</div>
                        <div class="text-xs text-gray-500">${ex.designation}</div>
                    </div>
                    <button onclick="removeExaminer(${idx})" class="text-red-500 hover:text-red-700 px-2">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }

        // Chief Search (Simple)
        const chiefInput = document.getElementById('chiefInput');
        const chiefSugg = document.getElementById('chiefSuggestions');
        chiefInput.addEventListener('input', () => {
             const val = chiefInput.value.toLowerCase();
             if(val.length < 3) { chiefSugg.classList.add('hidden'); return; }
             const matches = facultyData.filter(f => f.name.toLowerCase().includes(val)).slice(0, 5);
             showSuggestions(matches.map(m=>m.name), chiefInput, chiefSugg, (n) => chiefInput.value = n);
        });

        // --- Logic & Calculation ---
        function updateEstimates() {
            if(!currentDiscipline) return;
            
            const totalPresent = parseInt(document.getElementById('summaryScriptCount').textContent);
            const teamSize = additionalExaminers.length;
            const ruleKey = document.querySelector('input[name="quotaRule"]:checked').value;
            const rule = RULES[ruleKey];
            const dailyQuotaPerExaminer = rule.FN + rule.AN;
            
            const totalDailyCapacity = teamSize * dailyQuotaPerExaminer;
            
            let days = 0;
            if (teamSize > 0) {
                days = Math.ceil(totalPresent / totalDailyCapacity);
                document.getElementById('estimatedDaysDisplay').textContent = days + " Days";
                document.getElementById('capacityDisplay').textContent = `Capacity: ${totalDailyCapacity} scripts/day (${teamSize} examiners)`;
                generateDateInputs(days);
            } else {
                document.getElementById('estimatedDaysDisplay').textContent = "0 Days";
                document.getElementById('capacityDisplay').textContent = "Add examiners to calculate";
                document.getElementById('dateMappingContainer').innerHTML = '<div class="text-center text-gray-400 text-sm py-8">Add examiners to calculate schedule.</div>';
            }
        }

        function generateDateInputs(numDays) {
            const container = document.getElementById('dateMappingContainer');
            container.innerHTML = '';
            for(let i=1; i<=numDays; i++) {
                const div = document.createElement('div');
                div.className = "flex items-center gap-2 bg-gray-50 p-2 rounded border";
                div.innerHTML = `
                    <span class="text-xs font-bold text-gray-500 w-12">Day ${i}</span>
                    <input type="date" id="date_day_${i}" class="border rounded px-2 py-1 text-sm flex-1 outline-none focus:border-indigo-500">
                `;
                container.appendChild(div);
            }
        }

        // --- Core Algorithm: Parallel Distribution ---
        function generatePlan() {
            if(additionalExaminers.length === 0) return alert("Please add at least one Additional Examiner.");
            
            const ruleKey = document.querySelector('input[name="quotaRule"]:checked').value;
            const quota = RULES[ruleKey];
            const sessions = ['FN', 'AN'];
            
            generatedPlan = []; // Reset
            
            // Queue of Students (Already Sorted)
            // We need to consume this queue sequentially
            let queueIndex = 0;
            const totalStudents = pooledStudents.length;
            
            // Get Dates
            const daysCount = parseInt(document.getElementById('estimatedDaysDisplay').textContent);
            
            for (let d = 1; d <= daysCount; d++) {
                const dateInput = document.getElementById(`date_day_${d}`);
                const dateStr = (dateInput && dateInput.value) ? formatDate(dateInput.value) : `Day ${d}`;
                
                // For each Session
                sessions.forEach(sess => {
                    const sessionQuota = (sess === 'FN') ? quota.FN : quota.AN;
                    
                    // Assign to each examiner in team
                    additionalExaminers.forEach(examiner => {
                        if (queueIndex >= totalStudents) return; // Stop if no students left
                        
                        let currentBundle = {
                            date: dateStr,
                            session: sess,
                            examiner: examiner.name,
                            startReg: null,
                            endReg: null,
                            paper: null, // Keep track of paper to detect changes
                            count: 0
                        };
                        
                        let assignedCount = 0;
                        
                        // Fill Quota
                        while (assignedCount < sessionQuota && queueIndex < totalStudents) {
                            const student = pooledStudents[queueIndex];
                            const isPresent = (student.Attendance || '').toUpperCase().includes('PRESENT');
                            
                            // Initialize Bundle Start
                            if (currentBundle.startReg === null) {
                                currentBundle.startReg = student.RegNo;
                                currentBundle.paper = student.Paper;
                            }
                            
                            // Check for Paper Change? 
                            // If we want strictly separate bundles for separate papers, we break here.
                            // If we want "Sum All" regardless of paper, we continue.
                            // Better UX: Show "Multiple Papers" if mixed, or break line.
                            // Let's keep it simple: Just fill the quota. The Range implies the students.
                            
                            currentBundle.endReg = student.RegNo;
                            // Update Paper: if it changes, maybe note it? 
                            // For simplicity, we just list the Paper of the *start* or "Mixed".
                            if(student.Paper !== currentBundle.paper) currentBundle.paper = "Mixed / Multiple";
                            
                            if (isPresent) assignedCount++;
                            queueIndex++;
                        }
                        
                        currentBundle.count = assignedCount;
                        if (currentBundle.count > 0 || (currentBundle.startReg)) {
                            generatedPlan.push(currentBundle);
                        }
                    });
                });
            }
            
            renderOutputTable();
        }

        function renderOutputTable() {
            const tbody = document.querySelector('#distributionTable tbody');
            tbody.innerHTML = '';
            
            generatedPlan.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b";
                tr.innerHTML = `
                    <td class="px-4 py-3 font-medium text-indigo-700">${row.date} <span class="text-xs text-gray-500 bg-gray-100 px-1 rounded ml-1">${row.session}</span></td>
                    <td class="px-4 py-3 font-medium text-gray-800">${row.examiner}</td>
                    <td class="px-4 py-3 text-xs text-gray-500 max-w-xs truncate" title="${row.paper}">${row.paper}</td>
                    <td class="px-4 py-3 font-mono text-xs text-gray-600">${row.startReg} - ${row.endReg}</td>
                    <td class="px-4 py-3 text-center font-bold text-green-600">${row.count}</td>
                `;
                tbody.appendChild(tr);
            });
            
            document.getElementById('outputSection').classList.remove('hidden');
            document.getElementById('outputSection').scrollIntoView({behavior: 'smooth'});
        }

        // --- Helpers ---
        function showSuggestions(list, input, container, callback) {
            container.innerHTML = '';
            if (list.length === 0) { container.classList.add('hidden'); return; }
            
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = item;
                div.onclick = () => {
                    if(callback) callback(item);
                    container.classList.add('hidden');
                };
                container.appendChild(div);
            });
            container.classList.remove('hidden');
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-GB');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFillColor(67, 56, 202); // Indigo
            doc.rect(0, 0, 210, 20, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(16);
            doc.text("Valuation Board Schedule", 14, 13);
            
            doc.setTextColor(0,0,0);
            doc.setFontSize(11);
            doc.text(`Board: ${currentDiscipline}`, 14, 30);
            doc.text(`Chief Examiner: ${document.getElementById('chiefInput').value || 'Not Assigned'}`, 14, 36);
            
            doc.autoTable({
                html: '#distributionTable',
                startY: 45,
                theme: 'grid',
                headStyles: { fillColor: [55, 65, 81] },
                styles: { fontSize: 9 }
            });

            doc.save(`${currentDiscipline}_Schedule.pdf`);
        }
    </script>
</body>
</html>
